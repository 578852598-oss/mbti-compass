<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MBTI 心理状态罗盘</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    /* 保持原有的 CSS 样式完全不变，为了视觉一致性，此处省略了部分通用样式，
       但保留了核心布局逻辑。你可以直接复用之前文件中的 <style> 块。
       下面是针对新逻辑可能需要的微调。
    */
    :root{
      --bg:#ffffff; --surface:#ffffff; --surface-2:#f8fafc; --line:#e5e7eb;
      --text:#0f172a; --muted:#475569; --muted-2:#64748b;
      --accent:#2563eb; --accent-2:#1d4ed8; --success:#16a34a; --warning:#d97706; --danger:#dc2626;
      --radius:18px; --shadow:0 12px 30px rgba(15, 23, 42, 0.08);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Inter, system-ui, sans-serif; color:var(--text); background: linear-gradient(180deg, #ffffff 0%, #f6f8ff 100%); }
    .container{ max-width: 860px; margin: 0 auto; padding: 28px 18px 80px; }
    
    /* Topbar & Controls */
    .topbar{ position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); background: rgba(255,255,255,0.78); border-bottom: 1px solid rgba(229,231,235,0.9); }
    .topbar-inner{ max-width: 860px; margin: 0 auto; padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:36px; height:36px; border-radius: 12px; background: rgba(37,99,235,0.1); border: 1px solid rgba(37,99,235,0.18); display:flex; align-items:center; justify-content:center; color: var(--accent); font-weight:700; }
    
    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .field{ display:flex; align-items:center; gap:8px; padding: 8px 12px; border: 1px solid var(--line); border-radius: 14px; background: #fff; }
    select{ border:none; outline:none; background: transparent; font-size: 14px; font-weight: 600; }
    
    .pill{ padding: 8px 12px; border-radius: 999px; background: rgba(37,99,235,0.06); color: var(--accent); font-size: 12px; font-weight: 600; border: 1px solid rgba(37,99,235,0.2); }
    .progress{ width: 100px; height: 8px; border-radius: 999px; background: #eef2ff; border: 1px solid rgba(37,99,235,0.12); overflow:hidden; }
    .progress > div{ height:100%; width:0%; background: var(--accent); transition: width .3s ease; }

    /* Cards & Form */
    h1{ font-family: "Noto Serif SC", serif; margin: 20px 0 8px; font-size: 28px; }
    .subtitle{ color: var(--muted); margin:0; font-size: 14px; line-height: 1.6; }
    
    .card{ background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 22px; margin-top: 14px; box-shadow: var(--shadow); }
    .card--error{ border-color: var(--danger); box-shadow: 0 0 0 1px var(--danger); }
    .qmeta{ display:flex; justify-content:space-between; margin-bottom: 10px; font-size: 12px; color: var(--muted-2); }
    .qtext{ font-size: 16px; font-weight: 600; margin-bottom: 16px; line-height: 1.6; }
    
    .scale{ display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; background: var(--surface-2); padding: 10px; border-radius: 14px; }
    .opt label{ display:flex; align-items:center; justify-content:center; height: 36px; border-radius: 8px; background: #fff; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; font-weight: 700; color: var(--muted); }
    .opt input{ display:none; }
    .opt input:checked + label{ background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
    .scale-ends{ display:flex; justify-content:space-between; font-size: 12px; color: var(--muted-2); margin-top: 6px; padding: 0 4px; }

    .btn{ width:100%; margin-top: 20px; padding: 14px; border-radius: 16px; background: var(--accent); color: #fff; border:none; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 10px 25px rgba(37,99,235,0.25); }
    .btn:hover{ background: var(--accent-2); }
    .btn-ghost{ background: #fff; border: 1px solid var(--line); padding: 8px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; }

    /* Result Section */
    #result{ display:none; margin-top: 20px; padding-bottom: 60px; }
    .grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    @media(min-width: 768px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    
    .stat{ padding: 16px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); }
    .stat .k{ font-size: 12px; color: var(--muted-2); margin-bottom: 6px; }
    .stat .v{ font-family: "Noto Serif SC", serif; font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .stat .d{ font-size: 12px; color: var(--muted); line-height: 1.4; }

    .chart-box{ margin-top: 14px; padding: 20px; background: #fff; border-radius: var(--radius); border: 1px solid var(--line); display:flex; flex-direction:column; align-items:center; }
    .chart-container{ position: relative; width: 100%; max-width: 400px; height: 300px; }
    
    .section{ margin-top: 14px; padding: 20px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius); }
    .section h3{ margin: 0 0 10px; font-size: 15px; }
    .section p{ margin: 0; font-size: 14px; line-height: 1.7; color: var(--muted); }

    /* Color Utilities */
    .c-good{ color: var(--success); } .c-warn{ color: var(--warning); } .c-bad{ color: var(--danger); } .c-high{ color: #7c3aed; }

    /* Loading Overlay */
    .loading{ position: fixed; inset: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); z-index: 50; display:none; align-items:center; justify-content:center; }
    .spinner{ width: 30px; height: 30px; border: 3px solid rgba(37,99,235,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .toast{ position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 99px; font-size: 13px; z-index: 100; display:none; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">MB</div>
        <div style="line-height:1.2">
          <b style="font-size:14px; display:block;">心理状态罗盘</b>
        </div>
      </div>
      <div class="controls">
        <div class="field">
          <label for="mbti-select" style="font-size:12px; color:var(--muted)">类型</label>
          <select id="mbti-select">
            <option>INTJ</option><option>INTP</option><option>INFJ</option><option>INFP</option>
            <option>ENFJ</option><option>ENFP</option><option>ENTJ</option><option>ENTP</option>
            <option>ISFJ</option><option>ISTP</option>
          </select>
        </div>
        <div class="progress"><div id="progress-bar"></div></div>
        <button id="reset-btn" class="btn-ghost" style="display:none; padding: 6px 12px; font-size:12px;">重测</button>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">
    <div style="text-align:center">
      <div class="spinner" style="margin:0 auto 10px;"></div>
      <div style="font-size:14px; font-weight:600; color:var(--muted)">正在通信中...</div>
    </div>
  </div>

  <div class="container">
    <header id="header">
      <h1>MBTI 心理状态罗盘</h1>
      <p class="subtitle">通过「认知成熟度 / 内耗倾向 / 压力失控 / 压力负荷 / 自洽度」五个维度，帮助你快速了解近期状态，并给出可执行的调整建议。</p>
    </header>

    <form id="quiz-form">
      <div id="questions-container">
        <!-- 题目将通过 JS 插入这里 -->
      </div>
      <button type="submit" class="btn" id="submit-btn">生成报告</button>
    </form>

    <div id="result">
      <div class="grid">
        <div class="stat"><div class="k">认知成熟度</div><div class="v" id="res-maturity">—</div><div class="d">思维与现实的整合程度</div></div>
        <div class="stat"><div class="k">自洽度</div><div class="v" id="res-coherence">—</div><div class="d">内在逻辑的一致性</div></div>
        <div class="stat"><div class="k">内耗倾向</div><div class="v" id="res-loop">—</div><div class="d">思维反刍与行动阻力</div></div>
        <div class="stat"><div class="k">压力失控 (Grip)</div><div class="v" id="res-grip">—</div><div class="d">情绪爆发与反常行为</div></div>
        <div class="stat"><div class="k">压力负荷</div><div class="v" id="res-load">—</div><div class="d">当前的心理承重</div></div>
        <div class="stat"><div class="k">状态指数</div><div class="v" id="res-overall">—</div><div class="d" id="res-pill">—</div></div>
      </div>

      <div class="chart-box">
        <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
          <b style="font-size:14px;">六维状态分布</b>
          <span class="pill" id="chart-pill">分析完成</span>
        </div>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>

      <div class="section">
        <h3>核心洞察</h3>
        <p id="res-insight">...</p>
      </div>

      <div class="section">
        <h3>调整建议</h3>
        <p id="res-advice">...</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===========================================
    // 配置与状态
    // ===========================================
    let currentQuestions = [];
    let currentType = "INTP";
    let myChart = null;

    // 常用 DOM
    const $ = (id) => document.getElementById(id);
    const setLoading = (show) => { $('loading').style.display = show ? 'flex' : 'none'; };
    const toast = (msg) => {
      const t = $('toast'); t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    };

    // ===========================================
    // API 交互逻辑
    // ===========================================
    
    // 1. 获取题目
    async function fetchQuestions(type) {
      setLoading(true);
      try {
        const res = await fetch(`/api/questions/${type}`);
        if (!res.ok) throw new Error("获取题目失败");
        const data = await res.json();
        currentQuestions = data; // 后端返回的是 [{id:1, text:"..."}, ...]
        renderQuestions();
      } catch (err) {
        console.error(err);
        toast("无法连接到后端服务器，请检查网络");
      } finally {
        setLoading(false);
      }
    }

    // 2. 提交答案
    async function submitAnswers(answersMap) {
      setLoading(true);
      try {
        const payload = {
          mbti: currentType,
          answers: answersMap // { "1": 5, "2": 3 ... }
        };
        
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("提交失败");
        const result = await res.json();
        
        renderResult(result);

      } catch (err) {
        console.error(err);
        toast("生成报告失败，请稍后重试");
      } finally {
        setLoading(false);
      }
    }

    // ===========================================
    // 渲染逻辑
    // ===========================================

    function renderQuestions() {
      const container = $('questions-container');
      container.innerHTML = "";
      $('result').style.display = 'none';
      $('quiz-form').style.display = 'block';
      $('reset-btn').style.display = 'none';
      updateProgress();

      currentQuestions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.qid = q.id;
        
        let html = `
          <div class="qmeta">
            <b>Q${idx + 1}</b>
            <span id="status-${q.id}">未作答</span>
          </div>
          <div class="qtext">${q.text}</div>
          <div class="scale">
        `;
        
        // 生成 1-6 选项
        for(let i=1; i<=6; i++){
          html += `
            <div class="opt">
              <input type="radio" name="q${q.id}" id="q${q.id}_${i}" value="${i}">
              <label for="q${q.id}_${i}">${i}</label>
            </div>
          `;
        }

        html += `</div>
          <div class="scale-ends">
            <span>完全不符</span>
            <span>完全符合</span>
          </div>
        `;
        card.innerHTML = html;
        container.appendChild(card);
      });

      // 绑定变更事件监听进度
      $('quiz-form').addEventListener('change', (e) => {
        if(e.target.name.startsWith('q')) {
          const qid = e.target.name.substring(1);
          $(`status-${qid}`).textContent = "已选";
          $(`status-${qid}`).style.color = "var(--success)";
          // 移除错误样式
          const card = document.querySelector(`.card[data-qid="${qid}"]`);
          if(card) card.classList.remove('card--error');
          updateProgress();
        }
      });
    }

    function updateProgress() {
      const data = new FormData($('quiz-form'));
      let count = 0;
      for(let pair of data.entries()) count++;
      const total = currentQuestions.length;
      const pct = total === 0 ? 0 : (count / total) * 100;
      $('progress-bar').style.width = `${pct}%`;
    }

    function renderResult(data) {
      // 1. 隐藏表单，显示结果
      $('quiz-form').style.display = 'none';
      $('result').style.display = 'block';
      $('reset-btn').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // 2. 填充数据
      const setVal = (id, val, suffix="") => {
        const el = $(id);
        el.textContent = val + suffix;
        // 简单着色逻辑
        el.className = "v";
        if(val >= 75) el.classList.add("c-high");
        else if(val >= 60) el.classList.add("c-good");
        else if(val <= 35) el.classList.add("c-good"); // Loop/Grip 低是好事，但这里通用处理
      };

      setVal('res-maturity', data.maturity);
      setVal('res-coherence', data.coherence);
      setVal('res-loop', data.loop); // 后端已归一化，高分代表高Loop
      setVal('res-grip', data.grip);
      setVal('res-load', data.load);
      setVal('res-overall', data.overall);
      
      $('res-pill').textContent = data.pill_text;
      $('chart-pill').textContent = data.pill_text;

      $('res-insight').textContent = data.insight;
      $('res-advice').textContent = data.advice;

      // 3. 渲染图表
      renderChart(data.chart_data);
    }

    function renderChart(dataArray) {
      const ctx = $('radarChart').getContext('2d');
      if(myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['认知成熟度', '自洽度', '内耗弹性', '压力弹性', '负荷余量', '状态指数'],
          datasets: [{
            label: '当前状态',
            data: dataArray, // 后端已经处理好了数据的反转逻辑，直接由外向内渲染
            backgroundColor: 'rgba(37, 99, 235, 0.2)',
            borderColor: '#2563eb',
            borderWidth: 2,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#2563eb'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              min: 0, max: 100,
              ticks: { display: false, stepSize: 20 },
              grid: { color: 'rgba(0,0,0,0.05)' },
              pointLabels: { font: { size: 12, weight:'600' }, color: '#64748b' }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ===========================================
    // 初始化与事件
    // ===========================================

    document.addEventListener("DOMContentLoaded", () => {
      // 初始加载
      fetchQuestions(currentType);

      // 切换类型
      $('mbti-select').addEventListener('change', (e) => {
        currentType = e.target.value;
        fetchQuestions(currentType);
      });

      // 重置
      $('reset-btn').addEventListener('click', () => {
        fetchQuestions(currentType); // 重新获取打乱的题目
      });

      // 提交表单
      $('quiz-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const answers = {};
        
        // 检查是否有漏答
        for(let q of currentQuestions) {
          const val = formData.get(`q${q.id}`);
          if(!val) {
            toast(`第 ${currentQuestions.indexOf(q)+1} 题未完成`);
            const card = document.querySelector(`.card[data-qid="${q.id}"]`);
            card.classList.add('card--error');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }
          answers[q.id] = parseInt(val);
        }

        submitAnswers(answers);
      });
    });

  </script>
</body>
</html>