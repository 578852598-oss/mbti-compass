<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MBTI 心理状态罗盘</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --surface:#ffffff; --surface-2:#f8fafc; --line:#e5e7eb;
      --text:#0f172a; --muted:#475569; --muted-2:#64748b;
      --accent:#2563eb; --accent-2:#1d4ed8; 
      --success:#16a34a; --warning:#d97706; --danger:#dc2626; --purple:#7c3aed;
      --radius:18px; --shadow:0 12px 30px rgba(15, 23, 42, 0.08);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Inter, system-ui, sans-serif; color:var(--text); background: linear-gradient(180deg, #ffffff 0%, #f6f8ff 100%); }
    .container{ max-width: 860px; margin: 0 auto; padding: 28px 18px 80px; }
    
    /* Topbar */
    .topbar{ position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); background: rgba(255,255,255,0.78); border-bottom: 1px solid rgba(229,231,235,0.9); }
    .topbar-inner{ max-width: 860px; margin: 0 auto; padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:36px; height:36px; border-radius: 12px; background: rgba(37,99,235,0.1); border: 1px solid rgba(37,99,235,0.18); display:flex; align-items:center; justify-content:center; color: var(--accent); font-weight:700; }
    
    .controls{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .field{ display:flex; align-items:center; gap:8px; padding: 6px 10px; border: 1px solid var(--line); border-radius: 12px; background: #fff; }
    select{ border:none; outline:none; background: transparent; font-size: 14px; font-weight: 600; cursor: pointer; }
    
    .progress{ width: 80px; height: 6px; border-radius: 999px; background: #eef2ff; border: 1px solid rgba(37,99,235,0.12); overflow:hidden; }
    .progress > div{ height:100%; width:0%; background: var(--accent); transition: width .3s ease; }

    h1{ font-family: "Noto Serif SC", serif; margin: 20px 0 8px; font-size: 28px; }
    .subtitle{ color: var(--muted); margin:0; font-size: 14px; line-height: 1.6; }

    /* Card & Form */
    .card{ background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 22px; margin-top: 14px; box-shadow: var(--shadow); }
    .card--error{ border-color: var(--danger); box-shadow: 0 0 0 1px var(--danger); }
    .qmeta{ display:flex; justify-content:space-between; margin-bottom: 10px; font-size: 12px; color: var(--muted-2); }
    .qtext{ font-size: 16px; font-weight: 600; margin-bottom: 16px; line-height: 1.6; }
    
    .scale{ display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; background: var(--surface-2); padding: 10px; border-radius: 14px; }
    .opt label{ display:flex; align-items:center; justify-content:center; height: 40px; border-radius: 8px; background: #fff; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; font-weight: 700; color: var(--muted); }
    .opt input{ display:none; }
    .opt input:checked + label{ background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 10px rgba(37,99,235,0.3); transform: translateY(-1px); }
    .scale-ends{ display:flex; justify-content:space-between; font-size: 12px; color: var(--muted-2); margin-top: 6px; padding: 0 4px; }

    .btn{ width:100%; margin-top: 20px; padding: 14px; border-radius: 16px; background: var(--accent); color: #fff; border:none; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 10px 25px rgba(37,99,235,0.25); }
    .btn:hover{ background: var(--accent-2); transform: translateY(-1px); }
    .btn-ghost{ background: #fff; border: 1px solid var(--line); padding: 6px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 12px; }

    /* Result Styling - 关键修复部分 */
    #result{ display:none; margin-top: 20px; padding-bottom: 60px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media(min-width: 768px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    
    .stat{ padding: 18px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); display:flex; flex-direction:column; }
    .stat .k{ font-size: 12px; color: var(--muted-2); margin-bottom: 8px; letter-spacing: 0.5px; }
    /* 数值的大字号显示 */
    .stat .v{ font-family: "Noto Serif SC", serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; line-height: 1.2; }
    .stat .d{ font-size: 12px; color: var(--muted); line-height: 1.5; margin-top: auto; }

    /* 颜色类 */
    .color-high{ color: var(--purple); }
    .color-mid{ color: var(--accent); }
    .color-low{ color: var(--muted-2); }
    .color-healthy{ color: var(--success); }
    .color-warn{ color: var(--warning); }
    .color-bad{ color: var(--danger); }

    .chart-box{ margin-top: 14px; padding: 20px; background: #fff; border-radius: var(--radius); border: 1px solid var(--line); display:flex; flex-direction:column; align-items:center; }
    .chart-container{ position: relative; width: 100%; max-width: 400px; height: 320px; }
    .pill{ padding: 4px 10px; border-radius: 99px; background: #f1f5f9; color: var(--text); font-size: 12px; font-weight: 600; }
    
    .section{ margin-top: 14px; padding: 20px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius); }
    .section h3{ margin: 0 0 10px; font-size: 15px; }
    .section p{ margin: 0; font-size: 14px; line-height: 1.7; color: var(--muted); }

    .loading{ position: fixed; inset: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); z-index: 50; display:none; align-items:center; justify-content:center; }
    .spinner{ width: 30px; height: 30px; border: 3px solid rgba(37,99,235,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .toast{ position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 99px; font-size: 13px; z-index: 100; display:none; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">MB</div>
        <div style="line-height:1.2">
          <b style="font-size:14px; display:block;">心理状态罗盘</b>
        </div>
      </div>
      <div class="controls">
        <div class="field">
          <label for="mbti-select" style="font-size:12px; color:var(--muted)">类型</label>
          <select id="mbti-select">
            <option>INTJ</option><option>INTP</option><option>INFJ</option><option>INFP</option>
            <option>ENFJ</option><option>ENFP</option><option>ENTJ</option><option>ENTP</option>
            <option>ISFJ</option><option>ISTP</option>
          </select>
        </div>
        <div class="progress"><div id="progress-bar"></div></div>
        <button id="reset-btn" class="btn-ghost" style="display:none;">重测</button>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">
    <div style="text-align:center">
      <div class="spinner" style="margin:0 auto 10px;"></div>
      <div style="font-size:14px; font-weight:600; color:var(--muted)">AI 正在分析...</div>
    </div>
  </div>

  <div class="container">
    <header id="header">
      <h1>MBTI 心理状态罗盘</h1>
      <p class="subtitle">通过后端 API 实时计算你的「认知成熟度 / 内耗倾向 / 压力失控」等多维状态。</p>
    </header>

    <form id="quiz-form">
      <div id="questions-container"></div>
      <button type="submit" class="btn" id="submit-btn">生成报告</button>
    </form>

    <div id="result">
      <div class="grid">
        <!-- 动态生成的卡片将放在这里，现在使用 JS 控制内容 -->
        <div class="stat" id="card-maturity">
          <div class="k">认知阶层 (Maturity)</div>
          <div class="v" id="v-maturity">—</div>
          <div class="d" id="d-maturity">—</div>
        </div>
        
        <div class="stat" id="card-loop">
          <div class="k">内耗倾向 (Loop)</div>
          <div class="v" id="v-loop">—</div>
          <div class="d" id="d-loop">—</div>
        </div>

        <div class="stat" id="card-grip">
          <div class="k">压力反应 (Grip)</div>
          <div class="v" id="v-grip">—</div>
          <div class="d" id="d-grip">—</div>
        </div>

        <div class="stat" id="card-load">
          <div class="k">压力负荷 (Load)</div>
          <div class="v" id="v-load">—</div>
          <div class="d" id="d-load">—</div>
        </div>

        <div class="stat" id="card-coherence">
          <div class="k">自洽度 (Coherence)</div>
          <div class="v" id="v-coherence">—</div>
          <div class="d" id="d-coherence">—</div>
        </div>

        <div class="stat" id="card-overall">
          <div class="k">状态指数 (Index)</div>
          <div class="v" id="v-overall">—</div>
          <div class="d" id="d-overall">—</div>
        </div>
      </div>

      <div class="chart-box">
        <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
          <b style="font-size:14px;">六维状态分布</b>
          <span class="pill" id="chart-pill">--</span>
        </div>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>

      <div class="section">
        <h3>核心洞察</h3>
        <p id="res-insight">...</p>
      </div>

      <div class="section">
        <h3>调整建议</h3>
        <p id="res-advice">...</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let currentQuestions = [];
    let currentType = "INTP";
    let myChart = null;

    const $ = (id) => document.getElementById(id);
    const setLoading = (show) => { $('loading').style.display = show ? 'flex' : 'none'; };
    const toast = (msg) => {
      const t = $('toast'); t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    };

    async function fetchQuestions(type) {
      setLoading(true);
      try {
        const res = await fetch(`/api/questions/${type}`);
        if (!res.ok) throw new Error("Connection Error");
        currentQuestions = await res.json();
        renderQuestions();
      } catch (err) {
        console.error(err);
        toast("连接服务器失败，请检查网络");
      } finally {
        setLoading(false);
      }
    }

    async function submitAnswers(answersMap) {
      setLoading(true);
      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mbti: currentType, answers: answersMap })
        });
        if (!res.ok) throw new Error("Error");
        const result = await res.json();
        renderResult(result);
      } catch (err) {
        toast("分析失败，请稍后重试");
      } finally {
        setLoading(false);
      }
    }

    function renderQuestions() {
      const container = $('questions-container');
      container.innerHTML = "";
      $('result').style.display = 'none';
      $('quiz-form').style.display = 'block';
      $('reset-btn').style.display = 'none';
      updateProgress();

      currentQuestions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.qid = q.id;
        let html = `
          <div class="qmeta"><b>Q${idx + 1}</b><span id="status-${q.id}">未作答</span></div>
          <div class="qtext">${q.text}</div>
          <div class="scale">`;
        for(let i=1; i<=6; i++){
          html += `<div class="opt">
            <input type="radio" name="q${q.id}" id="q${q.id}_${i}" value="${i}">
            <label for="q${q.id}_${i}">${i}</label>
          </div>`;
        }
        html += `</div><div class="scale-ends"><span>完全不符</span><span>完全符合</span></div>`;
        card.innerHTML = html;
        container.appendChild(card);
      });

      $('quiz-form').addEventListener('change', (e) => {
        if(e.target.name.startsWith('q')) {
          const qid = e.target.name.substring(1);
          $(`status-${qid}`).textContent = "已选";
          $(`status-${qid}`).style.color = "var(--success)";
          const card = document.querySelector(`.card[data-qid="${qid}"]`);
          if(card) card.classList.remove('card--error');
          updateProgress();
        }
      });
    }

    function updateProgress() {
      const data = new FormData($('quiz-form'));
      let count = 0; for(let pair of data.entries()) count++;
      const total = currentQuestions.length;
      $('progress-bar').style.width = total === 0 ? '0%' : `${(count / total) * 100}%`;
    }

    // ==========================================
    // 关键修复：把数字转换回文字显示
    // ==========================================
    function renderResult(data) {
      $('quiz-form').style.display = 'none';
      $('result').style.display = 'block';
      $('reset-btn').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // 1. 认知成熟度 (越高越好)
      const elM = $('v-maturity'); const descM = $('d-maturity');
      if (data.maturity >= 67) {
        elM.innerHTML = "高阶 · 整合者"; elM.className = "v color-high";
        descM.textContent = "思维与现实整合度高，行动稳定。";
      } else if (data.maturity >= 34) {
        elM.innerHTML = "中阶 · 探索者"; elM.className = "v color-mid";
        descM.textContent = "思路在成形，需持续迭代验证。";
      } else {
        elM.innerHTML = "低阶 · 固守者"; elM.className = "v color-low";
        descM.textContent = "易被旧模式牵引，需引入外部反馈。";
      }

      // 2. 内耗倾向 (越低越好) -> 后端返回的 data.loop 也是越高越严重
      const elL = $('v-loop'); const descL = $('d-loop');
      if (data.loop < 35) {
        elL.innerHTML = "低"; elL.className = "v color-healthy";
        descL.textContent = "启动成本低，很少反复纠结。";
      } else if (data.loop < 65) {
        elL.innerHTML = "中"; elL.className = "v color-warn";
        descL.textContent = "有一定精神反刍，偶尔卡在细节。";
      } else {
        elL.innerHTML = "高"; elL.className = "v color-bad";
        descL.textContent = "更容易自我攻击，行动阻力大。";
      }

      // 3. 压力反应 Grip (越低越好)
      const elG = $('v-grip'); const descG = $('d-grip');
      if (data.grip < 35) {
        elG.innerHTML = "低"; elG.className = "v color-healthy";
        descG.textContent = "情绪稳定，压力信号较少。";
      } else if (data.grip < 65) {
        elG.innerHTML = "中"; elG.className = "v color-warn";
        descG.textContent = "压力下偶尔出现反常或爆发。";
      } else {
        elG.innerHTML = "高"; elG.className = "v color-bad";
        descG.textContent = "处在高压边缘，注意力难集中。";
      }

      // 4. 压力负荷 Load (越低越好)
      const elLoad = $('v-load'); const descLoad = $('d-load');
      if (data.load < 35) {
        elLoad.innerHTML = "轻"; elLoad.className = "v color-healthy";
        descLoad.textContent = "余量充足，节奏较松。";
      } else if (data.load < 65) {
        elLoad.innerHTML = "中"; elLoad.className = "v color-warn";
        descLoad.textContent = "强度适中，注意别长期无休。";
      } else {
        elLoad.innerHTML = "重"; elLoad.className = "v color-bad";
        descLoad.textContent = "整体偏满，优先做减负恢复。";
      }

      // 5. 自洽度 Coherence (越高越好)
      const elC = $('v-coherence'); const descC = $('d-coherence');
      if (data.coherence >= 70) {
        elC.innerHTML = "高"; elC.className = "v color-high";
        descC.textContent = "作答一致，内在逻辑清晰。";
      } else if (data.coherence >= 55) {
        elC.innerHTML = "中"; elC.className = "v color-mid";
        descC.textContent = "略有波动，但仍可自我校准。";
      } else {
        elC.innerHTML = "低"; elC.className = "v color-warn";
        descC.textContent = "近期摇摆较多，建议先稳节奏。";
      }

      // 6. 状态指数 Overall (越高越好)
      const elO = $('v-overall'); const descO = $('d-overall');
      const pillText = data.pill_text; // 后端算好的 "充盈/可用/高压"
      
      let oClass = "color-mid";
      if (data.overall >= 75) oClass = "color-high";
      else if (data.overall >= 55) oClass = "color-healthy";
      else if (data.overall >= 35) oClass = "color-warn";
      else oClass = "color-bad";
      
      elO.innerHTML = `${pillText} · <span style="font-size:0.8em">${data.overall}/100</span>`;
      elO.className = "v " + oClass;
      descO.textContent = "综合各项指标的整体效能。";
      
      $('chart-pill').textContent = pillText;
      $('chart-pill').style.color = "var(--text)";

      $('res-insight').textContent = data.insight;
      $('res-advice').textContent = data.advice;

      renderChart(data.chart_data);
    }

    function renderChart(dataArray) {
      const ctx = $('radarChart').getContext('2d');
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['认知成熟度', '自洽度', '内耗弹性', '压力弹性', '负荷余量', '状态指数'],
          datasets: [{
            label: '当前状态',
            data: dataArray,
            backgroundColor: 'rgba(37, 99, 235, 0.25)',
            borderColor: '#2563eb',
            borderWidth: 2,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#2563eb',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              min: 0, max: 100,
              ticks: { display: false, stepSize: 20 },
              grid: { color: 'rgba(0,0,0,0.06)' },
              angleLines: { color: 'rgba(0,0,0,0.06)' },
              pointLabels: { font: { size: 12, family:'Inter' }, color: '#64748b' }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchQuestions(currentType);
      $('mbti-select').addEventListener('change', (e) => { currentType = e.target.value; fetchQuestions(currentType); });
      $('reset-btn').addEventListener('click', () => { fetchQuestions(currentType); });
      $('quiz-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(e.target);
        const answers = {};
        for(let q of currentQuestions) {
          const val = data.get(`q${q.id}`);
          if(!val) {
            toast(`Q${currentQuestions.indexOf(q)+1} 未完成`);
            const card = document.querySelector(`.card[data-qid="${q.id}"]`);
            card.classList.add('card--error'); card.scrollIntoView({block:'center',behavior:'smooth'});
            return;
          }
          answers[q.id] = parseInt(val);
        }
        submitAnswers(answers);
      });
    });
  </script>
</body>
</html>