<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MBTI 心理状态罗盘</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --surface:#ffffff;
      --surface-2:#f8fafc;
      --line:#e5e7eb;
      --text:#0f172a;
      --muted:#475569;
      --muted-2:#64748b;

      --accent:#2563eb;
      --accent-2:#1d4ed8;
      --success:#16a34a;
      --warning:#d97706;
      --danger:#dc2626;

      --radius:18px;
      --shadow:0 12px 30px rgba(15, 23, 42, 0.08);
      --shadow-soft:0 8px 20px rgba(15, 23, 42, 0.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Serif SC", Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, #ffffff 0%, #f6f8ff 100%);
    }

    .container{
      max-width: 860px;
      margin: 0 auto;
      padding: 28px 18px 80px;
    }

    /* 顶部栏 */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.78);
      border-bottom: 1px solid rgba(229,231,235,0.9);
    }
    .topbar-inner{
      max-width: 860px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      width:36px; height:36px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,0.25), rgba(37,99,235,0.05));
      border: 1px solid rgba(37,99,235,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--accent);
      font-weight:700;
    }
    .brand-title{
      line-height:1.15;
    }
    .brand-title b{
      display:block;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .brand-title span{
      font-size: 12px;
      color: var(--muted-2);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .field{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      box-shadow: var(--shadow-soft);
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    select{
      border:none;
      outline:none;
      background: transparent;
      font-size: 14px;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      padding-right: 4px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.2);
      color: var(--accent);
      background: rgba(37,99,235,0.06);
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .progress{
      width: 180px;
      height: 10px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid rgba(37,99,235,0.12);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), #60a5fa);
      transition: width .25s ease;
    }

    /* 页面标题 */
    header{
      padding: 22px 0 10px;
      text-align:left;
    }
    h1{
      margin: 0 0 8px 0;
      font-family: "Noto Serif SC", serif;
      letter-spacing: 0.2px;
      font-size: 28px;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      max-width: 680px;
      line-height: 1.6;
      font-size: 14px;
    }
    .hint{
      margin-top: 12px;
      color: var(--muted-2);
      font-size: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .hint span{
      padding: 6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
    }

    /* 卡片 */
    .card{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 22px;
      margin-top: 14px;
      box-shadow: var(--shadow);
    }
    .card--error{
      border-color: rgba(220,38,38,0.35);
      box-shadow: 0 14px 30px rgba(220, 38, 38, 0.08);
    }
    .qmeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      color: var(--muted-2);
      font-size: 12px;
    }
    .qmeta b{
      color: var(--text);
      font-weight: 700;
      letter-spacing:0.2px;
    }
    .qstatus{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight: 600;
      color: var(--muted-2);
    }
    .dot{
      width:8px; height:8px;
      border-radius:999px;
      background: #cbd5e1;
    }
    .qstatus.done{ color: var(--success); }
    .qstatus.done .dot{ background: var(--success); }

    .qtext{
      font-size: 16px;
      line-height: 1.65;
      color: var(--text);
      font-weight: 600;
      margin: 6px 0 16px;
    }

    /* 量表 */
    .scale{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      align-items:center;
      padding: 14px;
      background: var(--surface-2);
      border: 1px solid var(--line);
      border-radius: 16px;
    }
    .scale-ends{
      width:100%;
      display:flex;
      justify-content:space-between;
      color: var(--muted-2);
      font-size: 12px;
      margin-top: 6px;
      padding: 0 6px;
    }

    .opt{
      position:relative;
      min-width: 0;
      display:flex;
      justify-content:center;
    }
    .opt input{ display:none; }
    .opt label{
      width: 100%;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.12);
      background: rgba(255,255,255,0.95);
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:700;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease, color .12s ease, background .12s ease;
      user-select:none;
    }
    .opt input:checked + label{
      background: rgba(37,99,235,0.08);
      border-color: rgba(37,99,235,0.35);
      color: var(--accent-2);
      box-shadow: 0 10px 22px rgba(37,99,235,0.12);
      transform: translateY(-1px);
    }

    /* 按钮 */
    .btn{
      width:100%;
      margin-top: 16px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(37,99,235,0.25);
      background: linear-gradient(90deg, rgba(37,99,235,1), rgba(96,165,250,1));
      color:#fff;
      font-weight: 700;
      font-size: 15px;
      cursor:pointer;
      box-shadow: 0 14px 32px rgba(37,99,235,0.18);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 18px 40px rgba(37,99,235,0.2); }
    .btn:active{ transform: translateY(0px); }

    .btn-ghost{
      width:auto;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-soft);
      font-weight: 700;
      cursor:pointer;
      color: var(--text);
    }

    /* 结果区 */
    #result{
      display:none;
      margin-top: 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: repeat(3, 1fr); }
    }

    .stat{
      padding: 18px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow);
    }
    .stat .k{
      font-size: 12px;
      color: var(--muted-2);
      margin-bottom: 10px;
      letter-spacing: 0.2px;
    }
    .stat .v{
      font-family: "Noto Serif SC", serif;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .stat .d{
      font-size: 12px;
      color: var(--muted);
      line-height:1.5;
    }

    .color-high{ color:#7c3aed; }
    .color-mid{ color: var(--accent); }
    .color-low{ color:#64748b; }

    .color-healthy{ color: var(--success); }
    .color-loop{ color: var(--warning); }
    .color-grip{ color: var(--danger); }

    /* 图表样式更新 */
    .chart {
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--shadow);
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 420px; /* 电脑端限宽 */
      height: 320px;    /* 固定高度，适合雷达图 */
      margin: 0 auto;
    }
    @media (max-width: 480px) {
      .chart-container {
        height: 280px;
      }
    }

    .chart-head{
      width: 100%;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .chart-title b{
      display:block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .chart-title span{
      display:block;
      font-size: 12px;
      color: var(--muted-2);
      line-height: 1.4;
    }

    [data-feature][hidden]{
      display:none !important;
    }

    .section{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .section h3{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .section p{
      margin: 0;
      color: var(--muted);
      line-height: 1.75;
      font-size: 14px;
    }

    .callout{
      margin-top: 14px;
      padding: 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0.02));
      border: 1px solid rgba(37,99,235,0.18);
      color: var(--muted);
      box-shadow: var(--shadow-soft);
    }
    .callout b{ color: var(--text); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      z-index: 999;
      background: rgba(15,23,42,0.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
      display:none;
      max-width: calc(100% - 24px);
    }

    /* Loading */
    .loading{
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
    }
    .loading-inner{
      width: min(420px, calc(100% - 36px));
      padding: 18px;
      border-radius: 20px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .spinner{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid rgba(37,99,235,0.18);
      border-top-color: rgba(37,99,235,0.9);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    @media (max-width: 720px){
      .brand{ min-width: unset; }
      .progress{ width: 140px; }
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 24px; }
      .opt label{ width: 44px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">MB</div>
        <div class="brand-title">
          <b>心理状态罗盘</b>
          <span>轻量自测 · 非医疗诊断</span>
        </div>
      </div>

      <div class="controls">
        <div class="field" title="选择你的 MBTI 类型">
          <label for="mbti-select">类型</label>
          <select id="mbti-select" aria-label="MBTI 下拉选择">
            <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
            <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
            <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
            <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
          </select>
        </div>

        <div class="pill" id="type-pill">当前：<span id="type-text">INTP</span></div>

        <div class="progress" aria-label="答题进度">
          <div id="progress-bar"></div>
        </div>

        <button class="btn-ghost" id="reset-btn" type="button" style="display:none;">重新测评</button>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-inner" role="status" aria-live="polite">
      <div class="spinner"></div>
      <div>
        <div style="font-weight:700;">正在生成报告…</div>
        <div style="color: var(--muted-2); font-size: 12px; margin-top: 2px;">请稍等片刻</div>
      </div>
    </div>
  </div>

  <div class="container">
    <header id="header">
      <h1>MBTI 心理状态罗盘</h1>
      <p class="subtitle">
        通过「认知成熟度 / 内耗倾向 / 压力失控 / 压力负荷 / 自洽度」五个维度，帮助你快速了解近期状态，并给出可执行的调整建议。
      </p>
      <div class="hint">
        <span>量表：1（完全不符）→ 6（完全符合）</span>
        <span>共 <b id="q-total">30</b> 题</span>
        <span>建议：直觉作答，避免过度推演</span>
      </div>
    </header>

    <form id="form">
      <div id="questions"></div>
      <button class="btn" type="submit">生成报告</button>

      <div class="callout" data-feature="persistenceHint">
        <b>提示：</b>如果你中途离开页面，答题记录不会自动保存。
      </div>
    </form>

    <section id="result">
      <div class="grid">
        <div class="stat">
          <div class="k">认知阶层（Maturity）</div>
          <div class="v" id="maturity-v">—</div>
          <div class="d" id="maturity-d">—</div>
        </div>

        <div class="stat">
          <div class="k">内耗倾向（Loop）</div>
          <div class="v" id="loop-v">—</div>
          <div class="d" id="loop-d">—</div>
        </div>

        <div class="stat">
          <div class="k">压力反应（Grip）</div>
          <div class="v" id="grip-v">—</div>
          <div class="d" id="grip-d">—</div>
        </div>

        <div class="stat">
          <div class="k">压力负荷（Load）</div>
          <div class="v" id="load-v">—</div>
          <div class="d" id="load-d">—</div>
        </div>

        <div class="stat">
          <div class="k">自洽度（Coherence）</div>
          <div class="v" id="coh-v">—</div>
          <div class="d" id="coh-d">—</div>
        </div>

        <div class="stat">
          <div class="k">状态指数（Index）</div>
          <div class="v" id="overall-v">—</div>
          <div class="d" id="overall-d">—</div>
        </div>
      </div>

      <div class="chart">
        <div class="chart-head">
          <div class="chart-title">
            <b>状态罗盘</b> <span>六维状态分布图</span>
          </div>
          <div class="pill" id="overall-pill">—</div>
        </div>

        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </div>

      <div class="section">
        <h3>核心洞察</h3>
        <p id="insight">—</p>
      </div>

      <div class="section">
        <h3>下一步建议</h3>
        <p id="advice">—</p>
      </div>

      <div class="callout" data-feature="expansionHint" style="margin-top:14px;">
        <b>扩展模块：</b>你可以在这里接入「更长的成长指南 / 复盘模板 / 付费内容」等商业化能力。
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="alert"></div>

<script>
/**
 * ===================== 题库与配置 =====================
 */
const MBTI_BANK = {
  COMMON: {
    questions: [
      { id: 1,  text: "当你的推理与现实反馈不一致时，你愿意调整自己的判断。", type: "maturity", reversed: false },
      { id: 2,  text: "你常把想法停留在脑中推演，很难进入验证或执行。", type: "maturity", reversed: true  },
      { id: 3,  text: "你能承认情绪是信息的一种，并愿意倾听它。", type: "maturity", reversed: false },
      { id: 4,  text: "你更愿意依赖熟悉的方法，而回避探索新路径。", type: "maturity", reversed: true  },
      { id: 5,  text: "你经常“想得很多、动得很少”，导致计划反复推倒重来。", type: "maturity", reversed: true  },
      { id: 6,  text: "你能把抽象想法讲清楚，让别人听得懂、接得住。", type: "maturity", reversed: false },
      { id: 7,  text: "你很难对不同观点保持好奇，容易直接否定。", type: "maturity", reversed: true  },
      { id: 8,  text: "你既能提出新点子，也能耐心处理落地细节。", type: "maturity", reversed: false },
      { id: 9,  text: "你会因追求“更完美的方案”而迟迟无法启动。", type: "maturity", reversed: true  },
      { id: 10, text: "你会主动寻找外界反馈，以发现自己的盲点。", type: "maturity", reversed: false },

      { id: 11, text: "你最近会反复回想过去的失误，很难放下。", type: "loop", reversed: false },
      { id: 12, text: "面对新机会时，你的第一反应是担心重蹈覆辙。", type: "loop", reversed: false },
      { id: 13, text: "你会陷入长时间分析，但最后很难产出具体行动。", type: "loop", reversed: false },
      { id: 14, text: "你更相信自己掌握的细节，而对新方向缺乏信心。", type: "loop", reversed: false },
      { id: 15, text: "你会回避社交或新信息，因为它们让你更累。", type: "loop", reversed: false },
      { id: 16, text: "你会为一些并不关键的小问题消耗大量精力。", type: "loop", reversed: false },
      { id: 17, text: "你明明知道该推进，却迟迟动不起来。", type: "loop", reversed: false },
      { id: 18, text: "你会对建议变得更防御，觉得别人不理解你的处境。", type: "loop", reversed: false },
      { id: 19, text: "你会在脑中反复演练最坏情况，从而更难决定。", type: "loop", reversed: false },
      { id: 20, text: "你更倾向于维持熟悉的状态，而回避改变。", type: "loop", reversed: false },

      { id: 21, text: "压力大时，你会更敏感，容易误解别人的意图。", type: "grip", reversed: false },
      { id: 22, text: "你会用吃、睡、刷短视频等方式“麻醉式”恢复。", type: "grip", reversed: false },
      { id: 23, text: "你会因小事情绪爆发，和以往的自己不太一样。", type: "grip", reversed: false },
      { id: 24, text: "你会强烈渴望被看见、被肯定。", type: "grip", reversed: false },
      { id: 25, text: "你会觉得大脑很乱，难以保持清晰思考。", type: "grip", reversed: false },
      { id: 26, text: "你会用讽刺、冷处理等方式表达不满。", type: "grip", reversed: false },
      { id: 27, text: "你会觉得自己付出很多却得不到回报，从而更委屈。", type: "grip", reversed: false },
      { id: 28, text: "你很难集中注意力，容易机械性地刷手机。", type: "grip", reversed: false },
      { id: 29, text: "你会更在意他人评价，甚至做出不符合自己节奏的选择。", type: "grip", reversed: false },
      { id: 30, text: "你会出现明显的摆烂冲动，或想把事情一把推翻。", type: "grip", reversed: false }
    ]
  }
};

const SCALE_MIN = 1;
const SCALE_MAX = 6;
const FEATURES = { persistenceHint: false, expansionHint: false };
const SCALE_POINTS = [1,2,3,4,5,6];

let currentType = "INTP";
let currentQuestions = [];
let radarChart = null;

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function $(id){ return document.getElementById(id); }

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=> t.style.display = "none", 2600);
}

function setProgress(answered, total){
  const pct = total === 0 ? 0 : Math.round((answered / total) * 100);
  $("progress-bar").style.width = pct + "%";
}

function computeCategoryBounds(questions){
  const counts = {maturity:0, loop:0, grip:0};
  questions.forEach(q => counts[q.type]++);
  const min = {};
  const max = {};
  Object.keys(counts).forEach(k=>{
    min[k] = counts[k] * SCALE_MIN;
    max[k] = counts[k] * SCALE_MAX;
  });
  return {counts, min, max};
}

function normalize(score, min, max){
  if (max === min) return 0;
  const v = (score - min) / (max - min);
  return Math.round(Math.min(1, Math.max(0, v)) * 100);
}

function renderQuestions(){
  const bank = MBTI_BANK.COMMON;
  currentQuestions = shuffle([...bank.questions]);
  $("type-text").textContent = currentType;
  $("q-total").textContent = currentQuestions.length;
  const wrap = $("questions");
  wrap.innerHTML = "";

  currentQuestions.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.qid = q.id;

    const qmeta = document.createElement("div");
    qmeta.className = "qmeta";
    qmeta.innerHTML = `<b>问题 ${idx + 1} / ${currentQuestions.length}</b>
      <span class="qstatus" id="st-${q.id}"><span class="dot"></span><span>未作答</span></span>`;
    card.appendChild(qmeta);

    const qtext = document.createElement("div");
    qtext.className = "qtext";
    qtext.textContent = q.text;
    card.appendChild(qtext);

    const scale = document.createElement("div");
    scale.className = "scale";
    SCALE_POINTS.forEach(v=>{
      const opt = document.createElement("div");
      opt.className = "opt";
      opt.innerHTML = `
        <input type="radio" id="q${q.id}_${v}" name="q${q.id}" value="${v}" />
        <label for="q${q.id}_${v}">${v}</label>
      `;
      scale.appendChild(opt);
    });

    const ends = document.createElement("div");
    ends.className = "scale-ends";
    ends.innerHTML = `<span>完全不符</span><span>完全符合</span>`;
    card.appendChild(scale);
    card.appendChild(ends);
    wrap.appendChild(card);
  });
  setProgress(0, currentQuestions.length);
  $("form").addEventListener("change", onAnswerChange);
}

function onAnswerChange(e){
  const name = e.target && e.target.name;
  if (!name || !name.startsWith("q")) return;
  const qid = name.replace("q","");
  const st = $("st-" + qid);
  if (st){
    st.className = "qstatus done";
    st.innerHTML = `<span class="dot"></span><span>已作答</span>`;
  }
  const card = document.querySelector(`.card[data-qid="${qid}"]`);
  if (card) card.classList.remove("card--error");
  const formData = new FormData($("form"));
  let answered = 0;
  currentQuestions.forEach(q=>{ if (formData.get("q"+q.id)) answered++; });
  setProgress(answered, currentQuestions.length);
}

function findFirstUnanswered(formData){
  for (const q of currentQuestions){
    if (!formData.get("q"+q.id)) return q;
  }
  return null;
}

function scrollToQuestion(qid){
  const card = document.querySelector(`.card[data-qid="${qid}"]`);
  if (!card) return;
  card.classList.add("card--error");
  card.scrollIntoView({behavior:"smooth", block:"center"});
}

function setLoading(on){
  $("loading").style.display = on ? "flex" : "none";
}

function renderResult(res){
  const mV = $("maturity-v");
  const mD = $("maturity-d");
  if (res.m >= 80){
    mV.textContent = "高阶 · 整合者"; mV.className = "v color-high";
    mD.textContent = "能把想法、情绪与现实反馈合在一起，行动更稳定。";
  }else if (res.m >= 45){
    mV.textContent = "中阶 · 探索者"; mV.className = "v color-mid";
    mD.textContent = "思路与自我认知在成形，持续迭代会越来越顺。";
  }else{
    mV.textContent = "低阶 · 固守者"; mV.className = "v color-low";
    mD.textContent = "容易被旧模式牵引；更需要外部反馈与小步验证。";
  }

  const lV = $("loop-v"); const lD = $("loop-d");
  const gV = $("grip-v"); const gD = $("grip-d");
  const loadV = $("load-v"); const loadD = $("load-d");
  const cohV = $("coh-v"); const cohD = $("coh-d");
  const oV = $("overall-v"); const oD = $("overall-d");
  const oPill = $("overall-pill");
  const insight = $("insight");
  const advice = $("advice");

  if (res.l < 35){
    lV.textContent = "低"; lV.className = "v color-healthy"; lD.textContent = "反复推演较少，启动成本更低。";
  }else if (res.l < 65){
    lV.textContent = "中"; lV.className = "v color-mid"; lD.textContent = "有一定反刍，偶尔卡在细节里。";
  }else{
    lV.textContent = "高"; lV.className = "v color-loop"; lD.textContent = "更容易反复纠结，行动阻力增大。";
  }

  if (res.g < 35){
    gV.textContent = "低"; gV.className = "v color-healthy"; gD.textContent = "压力信号较轻，恢复更容易。";
  }else if (res.g < 65){
    gV.textContent = "中"; gV.className = "v color-mid"; gD.textContent = "负荷期需要刻意恢复与边界。";
  }else{
    gV.textContent = "高"; gV.className = "v color-grip"; gD.textContent = "处在高压边缘，注意力更难稳定。";
  }

  if (res.load < 35){
    loadV.textContent = "轻"; loadV.className = "v color-healthy"; loadD.textContent = "节奏较松，余量更足。";
  }else if (res.load < 65){
    loadV.textContent = "中"; loadV.className = "v color-mid"; loadD.textContent = "强度适中，注意别长期无休。";
  }else{
    loadV.textContent = "重"; loadV.className = "v color-grip"; loadD.textContent = "整体偏满，优先做减负与恢复。";
  }

  if (res.coh >= 80){
    cohV.textContent = "高"; cohV.className = "v color-high"; cohD.textContent = "作答更一致，内在标准较清晰。";
  }else if (res.coh >= 55){
    cohV.textContent = "中"; cohV.className = "v color-mid"; cohD.textContent = "状态略有波动，但仍可自我校准。";
  }else{
    cohV.textContent = "低"; cohV.className = "v color-loop"; cohD.textContent = "近期可能摇摆较多，建议先稳节奏。";
  }

  let overallLabel = "可用";
  let overallDesc = "状态可支撑日常推进，注意节奏与边界。";
  if (res.o >= 75){
    overallLabel = "充盈"; overallDesc = "恢复与输出相对平衡，适合做中长期推进。"; oV.className = "v color-high"; oPill.textContent = "充盈";
  }else if (res.o >= 55){
    overallLabel = "可用"; overallDesc = "可稳定推进，但避免把强度拉满太久。"; oV.className = "v color-healthy"; oPill.textContent = "可用";
  }else if (res.o >= 35){
    overallLabel = "偏疲"; overallDesc = "更需要恢复与拆解任务，先把可交付做小。"; oV.className = "v color-mid"; oPill.textContent = "偏疲";
  }else{
    overallLabel = "高压"; overallDesc = "建议减负优先：睡眠、饮食、轻运动与求助。"; oV.className = "v color-grip"; oPill.textContent = "高压";
  }
  oV.textContent = `${overallLabel} · ${res.o}/100`;
  oD.textContent = overallDesc;

  if (res.l < 35 && res.g < 35 && res.load < 65){
    insight.textContent = "你当前更像“稳态推进”：想得清楚、行动阻力不大，同时还能保留恢复空间。";
    advice.textContent = "把优势用在“可交付的小步”上：每周固定 1 次复盘，并留出 1～2 个无任务时段做恢复。";
  }else if (res.g >= 65 || res.load >= 75){
    insight.textContent = `你处在“高负荷/高压”区间：压力信号更强（Grip ${res.g}/100，负荷 ${res.load}/100），注意力更难稳定。`;
    advice.textContent = "优先做恢复与减负：把今天目标缩减为 1 件可交付小成果；睡眠与饮食先稳定，再做身体回正。";
  }else{
    insight.textContent = `你的内耗倾向偏高（Loop ${res.l}/100）：可能在反复推演、过度打磨或过度比较，导致启动成本变高。`;
    advice.textContent = "做一次“外部打断”：安排 30 分钟低门槛行动（整理/散步/写 10 行计划），让身体先动起来。";
  }

  // --- 雷达图绘制逻辑 ---
  if (radarChart) radarChart.destroy();
  const ctx = $("chart").getContext("2d");
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(37, 99, 235, 0.5)');
  gradient.addColorStop(1, 'rgba(37, 99, 235, 0.1)');

  const labels = ["认知成熟度", "自洽度", "内耗弹性", "压力弹性", "负荷余量", "状态指数"];
  // 数值处理：反向指标用 100 减去，使其变正向（图形越大越好）
  const values = [ res.m, res.coh, 100 - res.l, 100 - res.g, 100 - res.load, res.o ];

  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: labels,
      datasets: [{
        label: "当前状态",
        data: values,
        backgroundColor: gradient,
        borderColor: "#2563eb",
        borderWidth: 2,
        pointBackgroundColor: "#ffffff",
        pointBorderColor: "#2563eb",
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "rgba(15, 23, 42, 0.9)",
          padding: 10,
          cornerRadius: 8,
          displayColors: false,
          callbacks: { label: (c) => ` ${c.label}: ${c.raw} / 100` }
        }
      },
      scales: {
        r: {
          angleLines: { color: "rgba(0, 0, 0, 0.05)" },
          grid: { color: "rgba(0, 0, 0, 0.05)", circular: true },
          pointLabels: { font: { size: 12, weight: "600", family: '"Inter", sans-serif' }, color: "#475569" },
          ticks: { display: false, stepSize: 20 },
          min: 0, max: 100,
        }
      }
    }
  });
}

function showResult(){
  $("form").style.display = "none";
  $("result").style.display = "block";
  $("reset-btn").style.display = "inline-flex";
  window.scrollTo({top: 0, behavior: "smooth"});
}

function resetAll(){
  $("result").style.display = "none";
  $("form").reset();
  $("form").style.display = "block";
  $("reset-btn").style.display = "none";
  if (radarChart) { radarChart.destroy(); radarChart = null; }
  renderQuestions();
  window.scrollTo({top: 0, behavior: "smooth"});
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("[data-feature]").forEach(el=>{
    if (!FEATURES[el.dataset.feature]) el.setAttribute("hidden", "");
  });

  const sel = $("mbti-select");
  sel.value = "INTP";
  currentType = sel.value;
  renderQuestions();

  sel.addEventListener("change", () => {
    currentType = sel.value;
    $("type-text").textContent = currentType;
    resetAll();
    toast("已切换类型：" + currentType);
  });

  $("reset-btn").addEventListener("click", resetAll);

  $("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData($("form"));
    const firstMissing = findFirstUnanswered(formData);
    if (firstMissing){
      toast("还有未完成的题目，已定位。");
      scrollToQuestion(firstMissing.id);
      return;
    }

    setLoading(true);
    const {min, max} = computeCategoryBounds(currentQuestions);
    const scores = { maturity: 0, loop: 0, grip: 0 };
    const rawVals = [];

    currentQuestions.forEach(q=>{
      const raw = parseInt(formData.get("q"+q.id), 10);
      rawVals.push(raw);
      let v = raw;
      if (q.reversed) v = (SCALE_MAX + SCALE_MIN) - v;
      scores[q.type] += v;
    });

    const res = {
      m: normalize(scores.maturity, min.maturity, max.maturity),
      l: normalize(scores.loop,     min.loop,     max.loop),
      g: normalize(scores.grip,     min.grip,     max.grip)
    };

    const mean = rawVals.reduce((s,x)=>s+x,0) / rawVals.length;
    const load = Math.round(((mean - SCALE_MIN) / (SCALE_MAX - SCALE_MIN)) * 100);
    const variance = rawVals.reduce((s,x)=> s + Math.pow(x - mean, 2), 0) / rawVals.length;
    const std = Math.sqrt(variance);
    const coh = Math.round((1 - Math.min(1, std / 2.5)) * 100);

    const invLoop = 100 - res.l;
    const invGrip = 100 - res.g;
    const invLoad = 100 - load;
    const overall = Math.round(0.25 * res.m + 0.20 * coh + 0.20 * invLoop + 0.20 * invGrip + 0.15 * invLoad);

    res.load = load; res.coh = coh; res.o = overall;

    setTimeout(()=>{
      setLoading(false);
      renderResult(res);
      showResult();
    }, 650);
  });
});
</script>
</body>
</html>